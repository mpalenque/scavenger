<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover,user-scalable=no" />
  <title>QR Hunt - Find the Pieces</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; background:#000; color:#fff; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow:hidden; }

    /* Low-power: remove costly blurs */
    .low-power .top-bar, .low-power .bottom-panel, .low-power .btn { -webkit-backdrop-filter:none!important; backdrop-filter:none!important; }

    .camera-container { position:fixed; inset:0; background:#000; z-index:1; }
    #qr-reader { position:absolute; inset:0; width:100%; height:100%; background:#000; }

    #qr-reader video, #qr-reader canvas {
      position:absolute !important; inset:0 !important; width:100% !important; height:100% !important;
      object-fit: contain !important; transform:none !important; -webkit-transform:none !important;
      backface-visibility:hidden !important; -webkit-backface-visibility:hidden !important;
      filter:none !important; will-change:auto !important;
    }

    /* QR Detection Success Visual Feedback */
    .qr-detected {
      border-color: #4CAF50 !important;
      box-shadow: 0 0 25px rgba(76, 175, 80, 0.6) !important;
      animation: qrSuccess 1s ease-out;
    }
    
    @keyframes qrSuccess {
      0% { border-color: rgba(45,140,255,0.5); box-shadow: 0 0 18px rgba(45,140,255,0.22); }
      50% { border-color: #4CAF50; box-shadow: 0 0 30px rgba(76, 175, 80, 0.8); }
      100% { border-color: #4CAF50; box-shadow: 0 0 25px rgba(76, 175, 80, 0.6); }
    }

    .ui-overlay { position:fixed; inset:0; z-index:10; pointer-events:none; display:flex; flex-direction:column; }
    .ui-overlay > * { pointer-events:auto; }

    .top-bar { background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.3) 100%); padding: calc(env(safe-area-inset-top) + 0.5rem) 1rem 0.75rem 1rem; text-align:center; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    .top-bar h1 { font-size:1rem; font-weight:600; margin-bottom:0.25rem; text-shadow:0 2px 4px rgba(0,0,0,0.5); }
    .pieces-count { font-size:0.8rem; color:#2d8cff; font-weight:600; text-shadow:0 1px 2px rgba(0,0,0,0.5); }

    .qr-overlay { position:absolute; inset:0; z-index:5; display:flex; align-items:center; justify-content:center; pointer-events:none; }
    .qr-target { width:min(58vw, 220px); aspect-ratio:1/1; border:2px solid rgba(45,140,255,0.5); box-shadow:0 0 18px rgba(45,140,255,0.22); border-radius:12px; position:relative; transition: all 0.3s ease; }
    .qr-target::before, .qr-target::after { content:''; position:absolute; width:25px; height:25px; border:3px solid #2d8cff; }
    .qr-target::before { top:-3px; left:-3px; border-right:none; border-bottom:none; border-top-left-radius:8px; }
    .qr-target::after { bottom:-3px; right:-3px; border-left:none; border-top:none; border-bottom-right-radius:8px; }
    .qr-corner { position:absolute; width:25px; height:25px; border:3px solid #2d8cff; }
    .qr-corner.top-right { top:-3px; right:-3px; border-left:none; border-bottom:none; border-top-right-radius:8px; }
    .qr-corner.bottom-left { bottom:-3px; left:-3px; border-right:none; border-top:none; border-bottom-left-radius:8px; }

    .flash-overlay { position:absolute; inset:0; background: radial-gradient(ellipse at center, rgba(255,255,255,0.9) 0%, rgba(77,160,255,0.45) 35%, rgba(0,0,0,0) 70%); opacity:0; pointer-events:none; z-index:6; transform: scale(1.05); }
    .flash-animate { animation: flashPulse 600ms ease-out; }
    @keyframes flashPulse { 0% { opacity:0; transform:scale(1.1); filter:blur(1px);} 25% { opacity:1; transform:scale(1.0); filter:none;} 100% { opacity:0; transform:scale(1.0);} }

    /* QR Detection Status Display */
    .qr-status { position:absolute; bottom:2rem; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.9); padding:0.75rem 1.5rem; border-radius:25px; color:#fff; font-size:0.9rem; font-weight:600; backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.2); opacity:0; transition:all 0.3s ease; pointer-events:none; z-index:7; max-width:80vw; text-align:center; }
    .qr-status.show { opacity:1; }
    .qr-status.success { background:rgba(76,175,80,0.9); border-color:rgba(76,175,80,0.5); }

    .bottom-panel { margin-top:auto; background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 100%); padding:0.75rem; padding-bottom: calc(0.75rem + env(safe-area-inset-bottom)); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); max-height:35vh; overflow-y:auto; }
    .clue-section { margin-bottom:0.75rem; }
    .clue-text { background: rgba(45, 140, 255, 0.2); border: 1px solid rgba(45, 140, 255, 0.4); border-radius: 6px; padding: 0.6rem; text-align: center; font-size: 0.85rem; min-height: 2.2rem; display: flex; align-items: center; justify-content: center; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .pieces-grid { display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; max-height:200px; overflow-y:auto; }
    .piece-item { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 6px; padding: 0.5rem; font-size:0.8rem; display:flex; align-items:center; justify-content:space-between; cursor: pointer; transition: all 0.2s ease; }
    .piece-item:hover { background: rgba(255, 255, 255, 0.2); }
    .piece-item.obtained { background: rgba(76, 175, 80, 0.2); border-color: rgba(76, 175, 80, 0.4); }

    /* Button styles */
    .btn {
      background: rgba(45, 140, 255, 0.9);
      color: white;
      border: none;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(45, 140, 255, 0.3);
      transition: all 0.2s ease;
    }

    .btn:hover, .btn:active {
      background: rgba(45, 140, 255, 1);
      transform: translateY(-1px);
    }

    /* Hidden elements */
    .hidden {
      display: none !important;
    }

    /* Camera status */
    #camera-status {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #2d8cff;
      font-weight: 600;
      z-index: 3;
      background: rgba(0,0,0,0.8);
      padding: 1rem;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      white-space: nowrap;
    }

    /* Test section - positioned lower to avoid overlapping pieces */
    #test-section {
      position: fixed;
      bottom: 12rem; /* Moved higher to avoid pieces overlap */
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      border-radius: 12px;
      padding: 0.75rem;
      z-index: 25;
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255,255,255,0.2);
      max-width: 90vw;
    }

    .test-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 0.4rem;
    }

    .test-buttons .btn {
      padding: 0.4rem 0.6rem;
      font-size: 0.75rem;
      min-width: 0;
    }

    /* Hide html5-qrcode overlays completely */
    .qr-shaded-region, #qr-reader__scan_region, #qr-reader div[style*="border"] { display:none !important; visibility:hidden !important; }

    /* iOS fix */
    @supports (-webkit-touch-callout: none) {
      .top-bar, .bottom-panel { -webkit-backdrop-filter: none !important; backdrop-filter: none !important; }
      #qr-reader * { -webkit-transform:none !important; transform:none !important; }
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 1rem;
    }

    .modal-content {
      background: rgba(26, 31, 46, 0.95);
      padding: 2rem;
      border-radius: 16px;
      max-width: 90vw;
      width: 400px;
      max-height: 90vh;
      overflow-y: auto;
      border: 2px solid rgba(45, 140, 255, 0.3);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    /* Trivia styles */
    #trivia-options li {
      margin: 0.5rem 0;
    }

    #trivia-options button {
      width: 100%;
      padding: 0.75rem;
      background: rgba(45, 140, 255, 0.9);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    #trivia-options button:hover, #trivia-options button:active {
      background: rgba(45, 140, 255, 1);
      transform: translateY(-1px);
    }

    #trivia-options button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    #trivia-options button.correct {
      background: #4CAF50 !important;
    }

    #trivia-options button.incorrect {
      background: #f44336 !important;
    }
  </style>
  
  <script>
    (function(){
      try {
        const p = new URLSearchParams(location.search);
        window.__disableCamera = p.get('nocam') === '1';
        window.__lowPower = p.get('low') === '1';
        if (p.get('perf') === '1') localStorage.setItem('perfDebug','1');
        if (window.__lowPower) {
          document.documentElement.classList.add('low-power');
        }
      } catch (e) {}
    })();
  </script>
  
  <script>
    window.addEventListener('load', () => {
      console.log('Html5Qrcode available:', typeof Html5Qrcode !== 'undefined');
      
      if (typeof Html5Qrcode === 'undefined') {
        console.error('‚ùå html5-qrcode failed to load');
      }
    });
  </script>
</head>
<body>
  <div class="camera-container">
    <div id="qr-reader">
      <div id="camera-status">
        <div>üì∑ Camera Initializing...</div>
        <small style="opacity:0.7; margin-top:8px;">Please allow camera access</small>
      </div>
    </div>
    <div class="qr-overlay" aria-hidden="true">
      <div class="qr-target">
        <div class="qr-corner top-right"></div>
        <div class="qr-corner bottom-left"></div>
      </div>
      <div id="scan-flash" class="flash-overlay"></div>
      <!-- QR Detection Status -->
      <div id="qr-status" class="qr-status"></div>
    </div>
  </div>

  <div class="ui-overlay">
    <div class="top-bar safe-area-top">
      <h1>üîç QR Scavenger Hunt</h1>
      <div class="pieces-count"><span id="pieces-count">0/7</span> pieces collected</div>
    </div>
    <div class="bottom-panel safe-area-bottom">
      <div class="clue-section"><div class="clue-text">Scan a QR code to begin your hunt!</div></div>
      <div class="pieces-grid" id="pieces-status"></div>
    </div>
  </div>

  <div id="test-section" class="hidden">
    <h3 style="margin-bottom: 0.5rem; font-size: 0.9rem; text-align: center;">üß™ Test QR</h3>
    <div class="test-buttons">
      <button class="test-qr-btn btn" data-piece="piece_1">QR 1</button>
      <button class="test-qr-btn btn" data-piece="piece_2">QR 2</button>
      <button class="test-qr-btn btn" data-piece="piece_3">QR 3</button>
      <button class="test-qr-btn btn" data-piece="piece_4">QR 4</button>
      <button class="test-qr-btn btn" data-piece="piece_5">QR 5</button>
      <button class="test-qr-btn btn" data-piece="piece_6">QR 6</button>
      <button class="test-qr-btn btn" data-piece="piece_7">QR 7</button>
      <button id="reset-progress-btn" class="btn" style="background: rgba(255, 71, 87, 0.9); grid-column: 1 / -1;">üîÑ Reset</button>
    </div>
  </div>

  <div id="qr-reader-results" class="hidden"></div>
  <div id="detected-text" class="hidden"></div>

  <div id="trivia-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 id="trivia-title">üß† Trivia Question</h2>
      <p id="trivia-question" style="margin: 1rem 0; font-size: 1.1rem; line-height: 1.4;">Question will appear here</p>
      <ul id="trivia-options" style="list-style: none; padding: 0; margin: 1rem 0;"></ul>
      <div id="trivia-feedback" style="margin: 1rem 0; font-weight: bold; text-align: center; min-height: 1.5rem;"></div>
      <div style="text-align: center;"><button id="trivia-close" class="btn hidden">Continue</button></div>
    </div>
  </div>

  <div id="final-form" class="modal-overlay hidden">
    <div class="modal-content">
      <h2>üéâ Congratulations!</h2>
      <p>You've collected all 7 pieces! Please enter your name to complete the hunt:</p>
      <input type="text" id="player-name" placeholder="Your name" style="width: 100%; padding: 0.75rem; margin: 1rem 0; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">
      <div style="text-align: center;"><button id="submit-completion" class="btn">Complete Hunt!</button></div>
    </div>
  </div>

  <!-- html5-qrcode local -->
  <script src="./html5-qrcode.min.js"></script>
  
  <script type="module" src="./js/data.js"></script>
  <script type="module" src="./js/camera.js"></script>
  <script type="module" src="./js/perf.js"></script>
  <script type="module" src="./js/main.js"></script>
</body>
</html>
